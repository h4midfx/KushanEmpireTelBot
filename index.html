
<html lang="en">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ° Kushan Empire</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: #ffffff;
    padding: 20px;
    margin: 0;
  }
  h1, h2 {
    text-align: center;
  }
  button {
    padding: 8px 15px;
    margin: 5px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    font-weight: bold;
    background: #555;
    color: #fff;
  }
  button:hover { opacity: 0.8; }
  input, select {
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  img {
    max-width: 200px;
    margin-top: 10px;
    border-radius: 5px;
  }
  .entry {
    border: 1px solid #555;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
    background: #222;
    text-align: center;
  }
  #language-select button {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #444;
    color: #fff;
  }
  #section-select button {
    background: #555;
    color: #fff;
  }
  .admin-btn { background: #ff4444; color: #fff; }
  .delete-btn { background: #cc0000; color: #fff; margin-top: 5px; }
  #admin-note-section {
    border: 1px solid #555;
    background: #222;
    border-radius: 5px;
    padding: 15px;
    margin: 15px auto;
    max-width: 400px;
  }
  #admin-note-section label {
    display: block;
    margin-top: 10px;
  }
  #notes-display {
    border: 1px solid #555;
    background: #222;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    white-space: pre-wrap;
  }
</style>

<!-- Chart.js removed as not needed -->

</head>
<body>

<!-- Sprachwahl -->
<div id="language-select" style="text-align:center; margin-bottom:10px;">
  <button onclick="setLang('en')"><img src="https://flagcdn.com/us.svg" width="25" alt="English Flag" /> English</button>
  <button onclick="setLang('fa')"><img src="https://flagcdn.com/ir.svg" width="25" alt="Farsi Flag" /> ÙØ§Ø±Ø³ÛŒ</button>
</div>

<h1 id="page-title">ğŸ° Kushan Empire</h1>

<!-- Abteilungsauswahl -->
<div id="section-select" style="text-align:center; margin-bottom:10px;"></div>

<!-- MenÃ¼ -->
<div id="menu" style="text-align:center; margin-bottom:10px;"></div>

<!-- Suche & Sortierung -->
<div id="search-sort" style="text-align:center; margin-bottom:10px; display:none;">
  <input type="text" id="search" placeholder="" oninput="datenAnzeigen()" />
  <select id="sortOrder" onchange="datenAnzeigen()">
    <option value="newest">Newest first</option>
    <option value="oldest">Oldest first</option>
  </select>
</div>

<hr />

<div id="inhalt" style="min-height: 200px; max-width: 800px; margin: auto;"></div>

<!-- Admin Notiz-Bereich -->
<div id="admin-note-section" style="display:none;">
  <h3 id="note-title"></h3>
  <label for="note-text" id="label-note-text"></label>
  <textarea id="note-text" rows="4" style="width: 100%; border-radius:5px; padding:5px;"></textarea>

  <label for="note-from" id="label-note-from"></label>
  <input type="datetime-local" id="note-from" />

  <label for="note-to" id="label-note-to"></label>
  <input type="datetime-local" id="note-to" />

  <button onclick="saveNote()" style="margin-top: 10px;"></button>
  <button onclick="hideAdminNoteSection()" style="margin-top: 10px; background:#777;">Cancel</button>
</div>

<div id="notes-display" style="display:none;"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===================== FIREBASE =====================
const firebaseConfig = {
  apiKey: "AIzaSyDQvWVcwDQivNGysnvfm4fBBykNbYtnDZc",
  authDomain: "castel-game.firebaseapp.com",
  databaseURL: "https://castel-game-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "castel-game",
  storageBucket: "castel-game.appspot.com",
  messagingSenderId: "504558378124",
  appId: "1:504558378124:web:f494c563b755454770efa9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===================== TEXTE =====================
const texts = {
  en: {
    title: "ğŸ° Kushan Empire",
    addData: "â• Add New Data",
    viewData: "ğŸ“‚ View Saved Data",
    newAttack: "New Attack",
    attackName: "Who attacked?",
    enterName: "Enter attacker name",
    attackTarget: "Who was attacked?",
    enterTarget: "Enter target name",
    attackAlliance: "Which alliance was attacked?",
    enterAlliance: "Enter alliance",
    uploadImage: "Please upload an image",
    save: "Save",
    noData: "No data available.",
    lastAttack: "Last attack",
    time: "Time",
    alertEnter: "Please fill all fields and upload an image!",
    alertSaved: "Data saved online!",
    wrongPassword: "âŒ Wrong password!",
    accessGranted: "âœ… Access granted to ",
    delete: "Delete",
    searchPlaceholder: "Search attacker, target or alliance...",
    newestFirst: "Newest first",
    oldestFirst: "Oldest first",
    adminLogin: "ğŸ”‘ Admin Login",
    manageNotes: "ğŸ“ Manage Notes",
    noteTitle: "Admin Note Management",
    noteLabelText: "Note text:",
    noteLabelFrom: "Show note from (date/time):",
    noteLabelTo: "Show note until (date/time):",
    noteSaveBtn: "Save Note",
    cancelBtn: "Cancel",
    selectSectionPrompt: "Select section:",
    passwordPrompt: "Enter password for Kushan 1:"
  },
  fa: {
    title: "ğŸ° Ø§Ù…Ù¾Ø±Ø§ØªÙˆØ±ÛŒ Ú©ÙˆØ´Ø§Ù†",
    addData: "â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯",
    viewData: "ğŸ“‚ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§",
    newAttack: "Ø­Ù…Ù„Ù‡ Ø¬Ø¯ÛŒØ¯",
    attackName: "Ú†Ù‡ Ú©Ø³ÛŒ Ø­Ù…Ù„Ù‡ Ú©Ø±Ø¯ØŸ",
    enterName: "Ù†Ø§Ù… Ù…Ù‡Ø§Ø¬Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
    attackTarget: "Ø¨Ù‡ Ú†Ù‡ Ú©Ø³ÛŒ Ø­Ù…Ù„Ù‡ Ø´Ø¯ØŸ",
    enterTarget: "Ù†Ø§Ù… Ù‡Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
    attackAlliance: "Ú©Ø¯Ø§Ù… Ø§ØªØ­Ø§Ø¯ Ù…ÙˆØ±Ø¯ Ø­Ù…Ù„Ù‡ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØªØŸ",
    enterAlliance: "Ù†Ø§Ù… Ø§ØªØ­Ø§Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
    uploadImage: "Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ØªØµÙˆÛŒØ± Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯",
    save: "Ø°Ø®ÛŒØ±Ù‡",
    noData: "Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª",
    lastAttack: "Ø¢Ø®Ø±ÛŒÙ† Ø­Ù…Ù„Ù‡",
    time: "Ø²Ù…Ø§Ù†",
    alertEnter: "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ Ùˆ ØªØµÙˆÛŒØ± Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯!",
    alertSaved: "Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯!",
    wrongPassword: "âŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!",
    accessGranted: "âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ",
    delete: "Ø­Ø°Ù",
    searchPlaceholder: "Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ù…ØŒ Ù‡Ø¯Ù ÛŒØ§ Ø§ØªØ­Ø§Ø¯...",
    newestFirst: "Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ Ø§Ø¨ØªØ¯Ø§",
    oldestFirst: "Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§ Ø§Ø¨ØªØ¯Ø§",
    adminLogin: "ğŸ”‘ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±",
    manageNotes: "ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§",
    noteTitle: "Ù…Ø¯ÛŒØ±ÛŒØª ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…Ø¯ÛŒØ±",
    noteLabelText: "Ù…ØªÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:",
    noteLabelFrom: "Ù†Ù…Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø² (ØªØ§Ø±ÛŒØ®/Ø²Ù…Ø§Ù†):",
    noteLabelTo: "Ù†Ù…Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØªØ§ (ØªØ§Ø±ÛŒØ®/Ø²Ù…Ø§Ù†):",
    noteSaveBtn: "Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª",
    cancelBtn: "Ø§Ù†ØµØ±Ø§Ù",
    selectSectionPrompt: "Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø®Ø´:",
    passwordPrompt: "Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø®Ø´ Ú©ÙˆØ´Ø§Ù† 1 Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
  }
};

// ===================== VARIABLEN =====================
let currentLang = 'en';
let currentSection = null;
const KUSHAN1_PASSWORD = "12345";
let isAdmin = false;
const ADMIN_PASSWORD = "admin123";
const inhalt = document.getElementById("inhalt");

const sectionSelectDiv = document.getElementById("section-select");
const menuDiv = document.getElementById("menu");
const searchSortDiv = document.getElementById("search-sort");
const searchInput = document.getElementById("search");
const sortSelect = document.getElementById("sortOrder");

const adminNoteSection = document.getElementById("admin-note-section");
const noteTitle = document.getElementById("note-title");
const noteTextLabel = document.getElementById("label-note-text");
const noteFromLabel = document.getElementById("label-note-from");
const noteToLabel = document.getElementById("label-note-to");
const noteTextArea = document.getElementById("note-text");
const noteFromInput = document.getElementById("note-from");
const noteToInput = document.getElementById("note-to");
const notesDisplayDiv = document.getElementById("notes-display");

// ===================== SET LANGUAGE & UPDATE UI =====================
function setLang(lang) {
  currentLang = lang;
  document.title = texts[lang].title;
  document.getElementById("page-title").innerText = texts[lang].title;
  renderSectionButtons();
  renderMenuButtons();
  updatePlaceholders();
  resetView();
}

function updatePlaceholders() {
  searchInput.placeholder = texts[currentLang].searchPlaceholder;
  // Update sort options text
  sortSelect.options[0].text = texts[currentLang].newestFirst;
  sortSelect.options[1].text = texts[currentLang].oldestFirst;

  noteTitle.innerText = texts[currentLang].noteTitle;
  noteTextLabel.innerText = texts[currentLang].noteLabelText;
  noteFromLabel.innerText = texts[currentLang].noteLabelFrom;
  noteToLabel.innerText = texts[currentLang].noteLabelTo;
  adminNoteSection.querySelector("button").innerText = texts[currentLang].noteSaveBtn;
  adminNoteSection.querySelectorAll("button")[1].innerText = texts[currentLang].cancelBtn;
}

function renderSectionButtons() {
  sectionSelectDiv.innerHTML = `
    <button onclick="selectSection('kushan1')">ğŸ° Kushan 1 ğŸ”’</button>
    <button onclick="selectSection('kushan2')">ğŸ° Kushan 2 ğŸ”“</button>
  `;
}

function renderMenuButtons() {
  menuDiv.innerHTML = `
    <button onclick="neueDaten()">${texts[currentLang].addData}</button>
    <button onclick="datenAnzeigen()">${texts[currentLang].viewData}</button>
    <button onclick="adminLogin()">${texts[currentLang].adminLogin}</button>
    <button onclick="showAdminNoteSection()">${texts[currentLang].manageNotes}</button>
  `;
}

// ===================== RESET VIEW =====================
function resetView() {
  currentSection = null;
  isAdmin = false;
  inhalt.innerHTML = "";
  searchSortDiv.style.display = "none";
  notesDisplayDiv.style.display = "none";
  adminNoteSection.style.display = "none";
  searchInput.value = "";
  sortSelect.value = "newest";
}

// ===================== SECTION SELECTION =====================
function selectSection(section) {
  if(section === "kushan1") {
    const pw = prompt(texts[currentLang].passwordPrompt);
    if(pw !== KUSHAN1_PASSWORD) {
      alert(texts[currentLang].wrongPassword);
      return;
    }
  }
  currentSection = section;
  alert(texts[currentLang].accessGranted + section.toUpperCase());
  searchSortDiv.style.display = "block";
  datenAnzeigen();
}

// ===================== ADD NEW DATA FORM =====================
function neueDaten() {
  if(!currentSection) {
    alert("Please select a section first.");
    return;
  }
  adminNoteSection.style.display = "none";
  notesDisplayDiv.style.display = "none";
  searchSortDiv.style.display = "none";

  inhalt.innerHTML = `
    <h2>${texts[currentLang].newAttack}</h2>
    <p>${texts[currentLang].attackName}</p>
    <input type="text" id="attacker" placeholder="${texts[currentLang].enterName}" />
    <p>${texts[currentLang].attackTarget}</p>
    <input type="text" id="target" placeholder="${texts[currentLang].enterTarget}" />
    <p>${texts[currentLang].attackAlliance}</p>
    <input type="text" id="alliance" placeholder="${texts[currentLang].enterAlliance}" />
    <p>${texts[currentLang].uploadImage}</p>
    <input type="file" id="bild" accept="image/*" />
    <br /><br />
    <button onclick="speichern()">${texts[currentLang].save}</button>
  `;
}

// ===================== SAVE DATA =====================
function speichern() {
  const attacker = document.getElementById("attacker").value.trim();
  const target = document.getElementById("target").value.trim();
  const alliance = document.getElementById("alliance").value.trim();
  const bild = document.getElementById("bild").files[0];

  if(!attacker || !target || !alliance || !bild) {
    alert(texts[currentLang].alertEnter);
    return;
  }

  const reader = new FileReader();
  reader.onload = function() {
    db.ref("castelDaten/" + currentSection).push({
      attacker: attacker,
      target: target,
      alliance: alliance,
      bild: reader.result,
      zeit: new Date().toLocaleString()
    });
    alert(texts[currentLang].alertSaved);
    datenAnzeigen();
  };
  reader.readAsDataURL(bild);
}

// ===================== SHOW DATA =====================
function datenAnzeigen() {
  if(!currentSection) {
    inhalt.innerHTML = "";
    return;
  }
  adminNoteSection.style.display = "none";
  notesDisplayDiv.style.display = "none";
  searchSortDiv.style.display = "block";

  const searchValue = searchInput.value.toLowerCase();
  const sortOrder = sortSelect.value;

  inhalt.innerHTML = `<h2>${texts[currentLang].viewData} â€“ ${currentSection.toUpperCase()}</h2>`;

  db.ref("castelDaten/" + currentSection).once("value", snapshot => {
    const daten = snapshot.val();
    if(!daten) {
      inhalt.innerHTML += `<p>${texts[currentLang].noData}</p>`;
      return;
    }

    const datenArray = Object.keys(daten).map(key => ({ key, ...daten[key] }));
    datenArray.sort((a, b) => {
      const dateA = new Date(a.zeit);
      const dateB = new Date(b.zeit);
      return sortOrder === "newest" ? dateB - dateA : dateA - dateB;
    });

    let foundAny = false;

    datenArray.forEach(e => {
      if(
        e.attacker.toLowerCase().includes(searchValue) ||
        e.target.toLowerCase().includes(searchValue) ||
        e.alliance.toLowerCase().includes(searchValue)
      ) {
        foundAny = true;
        let html = `
          <div class="entry">
            <strong>${texts[currentLang].attackName}:</strong> ${e.attacker}<br>
            <strong>${texts[currentLang].attackTarget}:</strong> ${e.target}<br>
            <strong>${texts[currentLang].attackAlliance}:</strong> ${e.alliance}<br>
            <small>${e.zeit} / ${texts[currentLang].time}</small><br>
            <img src="${e.bild}" alt="Attack Image"><br>
        `;
        if(isAdmin) {
          html += `<button class="delete-btn" onclick="deleteEntry('${e.key}')">${texts[currentLang].delete}</button>`;
        }
        html += `</div>`;
        inhalt.innerHTML += html;
      }
    });

    if(!foundAny) {
      inhalt.innerHTML += `<p>${texts[currentLang].noData}</p>`;
    }
  });
}

// ===================== DELETE ENTRY =====================
function deleteEntry(key) {
  if(!isAdmin) {
    alert("âŒ Admin only!");
    return;
  }
  if(confirm("Do you really want to delete this entry?")) {
    db.ref("castelDaten/" + currentSection + "/" + key).remove();
    datenAnzeigen();
  }
}

// ===================== ADMIN LOGIN =====================
function adminLogin() {
  const pw = prompt(texts[currentLang].adminLogin + ":\n" + "Password:");
  if(pw === ADMIN_PASSWORD) {
    isAdmin = true;
    alert("âœ… Admin access granted!");
    datenAnzeigen();
  } else {
    alert(texts[currentLang].wrongPassword);
  }
}

// ===================== ADMIN NOTES MANAGEMENT =====================
function showAdminNoteSection() {
  if(!isAdmin) {
    alert("âŒ Admin only!");
    return;
  }
  inhalt.innerHTML = "";
  searchSortDiv.style.display = "none";
  notesDisplayDiv.style.display = "none";
  adminNoteSection.style.display = "block";

  // Lade Notiz aus DB, wenn vorhanden
  db.ref("adminNotes").once("value", snapshot => {
    const note = snapshot.val();
    if(note) {
      noteTextArea.value = note.text || "";
      noteFromInput.value = note.from || "";
      noteToInput.value = note.to || "";
    } else {
      noteTextArea.value = "";
      noteFromInput.value = "";
      noteToInput.value = "";
    }
  });

  updatePlaceholders(); // Update button text etc
}

function hideAdminNoteSection() {
  adminNoteSection.style.display = "none";
}

function saveNote() {
  const text = noteTextArea.value.trim();
  const from = noteFromInput.value;
  const to = noteToInput.value;

  if(!text || !from || !to) {
    alert("Please fill all note fields!");
    return;
  }

  // Speichere Notiz in DB
  db.ref("adminNotes").set({
    text: text,
    from: from,
    to: to
  }).then(() => {
    alert("Note saved!");
    adminNoteSection.style.display = "none";
    showNotesIfVisible();
  }).catch(() => {
    alert("Error saving note!");
  });
}

// ===================== SHOW NOTES TO USERS =====================
function showNotesIfVisible() {
  // Diese Funktion prÃ¼ft, ob wir eine gÃ¼ltige Notiz haben, die jetzt angezeigt werden soll
  db.ref("adminNotes").once("value", snapshot => {
    const note = snapshot.val();
    if(!note || !note.text || !note.from || !note.to) {
      notesDisplayDiv.style.display = "none";
      return;
    }

    const nowISO = new Date().toISOString();

    if(note.from <= nowISO && nowISO <= note.to) {
      notesDisplayDiv.style.display = "block";
      notesDisplayDiv.textContent = note.text;
    } else {
      notesDisplayDiv.style.display = "none";
    }
  });
}

// ===================== AUTOMATISCH LADEN =====================
window.onload = () => {
  setLang('en'); // Default Sprache
  showNotesIfVisible();
  // Falls gewÃ¼nscht, kann man ein Interval setzen, um Notizen automatisch zu prÃ¼fen:
  setInterval(showNotesIfVisible, 60 * 1000); // alle 60 Sekunden prÃ¼fen
};

</script>
</body>
</html>
